<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time ECG Web App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Real-Time ECG Signal</h1>
    <button id="connectBtn">Connect to ESP32</button>
    <canvas id="ecgCanvas" width="400" height="200"></canvas>

    <script>
        let rawValues = [];
        let smoothedValues = [];
        const windowSize = 50;
        const ctx = document.getElementById('ecgCanvas').getContext('2d');

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'ECG Signal',
                        borderColor: 'blue',
                        data: [],
                        fill: false
                    },
                    {
                        label: 'Smoothed ECG',
                        borderColor: 'red',
                        data: [],
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Samples'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'ECG Value'
                        }
                    }
                }
            }
        });

        const SERVICE_UUID = 'f7d6b2de-e1ab-49f7-b8a1-d1ac9b75c10a';
        const CHARACTERISTIC_UUID = 'd6f5458d-f522-4019-b116-36d3c9b8970e';

        async function connectToDevice() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                console.log('Connected to ESP32');

                characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', onDataReceived);

            } catch (error) {
                console.error('Error connecting to device:', error);
            }
        }

        function onDataReceived(event) {
            const value = event.target.value;
            const ecgValue = parseInt(new TextDecoder().decode(value));

            rawValues.push(ecgValue);

            if (rawValues.length > windowSize) {
                rawValues.shift();
            }

            const smoothedValue = rawValues.reduce((acc, val) => acc + val, 0) / rawValues.length;
            smoothedValues.push(smoothedValue);

            chart.data.labels.push(chart.data.labels.length);
            chart.data.datasets[0].data = rawValues;
            chart.data.datasets[1].data = smoothedValues;

            if (chart.data.labels.length > windowSize) {
                chart.data.labels.shift();
            }

            chart.update();
        }

        document.getElementById('connectBtn').addEventListener('click', connectToDevice);
    </script>
</body>
</html>
