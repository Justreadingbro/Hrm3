<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECG Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        canvas {
            max-width: 100%;
            max-height: 400px;
        }
    </style>
</head>
<body>
    <h1>ECG Data</h1>
    <canvas id="ecgChart"></canvas>
    <button id="connectButton">Connect to ECG</button>
    <script>
      let device;
      let server;
      let service;
      let characteristic;

      // Chart.js setup
      const ctx = document.getElementById('ecgChart').getContext('2d');
      const ecgChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: [],
              datasets: [{
                  label: 'ECG Data',
                  data: [],
                  borderColor: 'rgb(75, 192, 192)',
                  fill: false,
              }]
          },
          options: {
              scales: {
                  x: {
                      type: 'linear',
                      position: 'bottom'
                  }
              },
              animation: {
                  duration: 0 // Disable animation to get real-time updates
              }
          }
      });

      // Request Bluetooth device with specific services
      async function connectBluetooth() {
        try {
          device = await navigator.bluetooth.requestDevice({
            filters: [{ services: ['0000180d-0000-1000-8000-00805f9b34fb'] }] // Full Heart Rate Service UUID
          });

          // Connect to the device and get the Heart Rate service
          server = await device.gatt.connect();
          service = await server.getPrimaryService('0000180d-0000-1000-8000-00805f9b34fb'); // Full Heart Rate Service UUID
          characteristic = await service.getCharacteristic('00002a37-0000-1000-8000-00805f9b34fb'); // Full Heart Rate Measurement Characteristic UUID

          characteristic.startNotifications();
          characteristic.addEventListener('characteristicvaluechanged', handleData);
        } catch (error) {
          console.log('Error:', error);
        }
      }

      // Handle incoming data from Bluetooth device
      function handleData(event) {
        const ecgValue = event.target.value.getUint8(0); // ECG data is received as uint8
        const currentTime = new Date().getTime(); // Get current time

        // Update the chart with new data
        if (ecgChart.data.labels.length > 100) {
          ecgChart.data.labels.shift();
          ecgChart.data.datasets[0].data.shift();
        }

        ecgChart.data.labels.push(currentTime);
        ecgChart.data.datasets[0].data.push({ x: currentTime, y: ecgValue });
        ecgChart.update();
      }

      // Set up the button click event to trigger Bluetooth connection
      document.getElementById('connectButton').addEventListener('click', connectBluetooth);
    </script>
</body>
</html>
