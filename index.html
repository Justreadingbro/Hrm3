<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time ECG Web App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js for plotting -->
</head>
<body>
    <h1>Real-Time ECG Signal</h1>
    <button id="connectBtn">Connect to ESP32</button>
    <canvas id="ecgCanvas" width="400" height="200"></canvas>

    <script>
        // Variables for plotting
        let rawValues = [];  // Store raw ECG data
        let smoothedValues = [];  // Store smoothed ECG data (simple moving average)
        const windowSize = 50;  // Window size for smoothing
        const ctx = document.getElementById('ecgCanvas').getContext('2d');  // Get the canvas context for Chart.js

        // Initialize Chart.js for plotting ECG
        const chart = new Chart(ctx, {
            type: 'line',  // Line chart
            data: {
                labels: [],  // X-axis (time or sample points)
                datasets: [
                    {
                        label: 'ECG Signal',
                        borderColor: 'blue',
                        data: [],  // Raw ECG data
                        fill: false
                    },
                    {
                        label: 'Smoothed ECG',
                        borderColor: 'red',
                        data: [],  // Smoothed ECG data
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Samples'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'ECG Value'
                        }
                    }
                }
            }
        });

        // Define Bluetooth Device and Characteristic UUIDs
        const SERVICE_UUID = 'f7d6b2de-e1ab-49f7-b8a1-d1ac9b75c10a';  // Your ESP32 service UUID
        const CHARACTERISTIC_UUID = 'd6f5458d-f522-4019-b116-36d3c9b8970e';  // Your ESP32 characteristic UUID

        // Function to connect to the ESP32 via Bluetooth
        async function connectToDevice() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                console.log('Connected to ESP32');

                // Listen for notifications from the ESP32
                characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', onDataReceived);

            } catch (error) {
                console.error('Error connecting to device:', error);
            }
        }

        // Function to handle the data received from the ESP32
        function onDataReceived(event) {
            const value = event.target.value;
            const ecgValue = parseInt(new TextDecoder().decode(value));  // Decode the value from the BLE characteristic

            // Update the raw ECG values
            rawValues.push(ecgValue);

            // Apply smoothing (simple moving average)
            if (rawValues.length > windowSize) {
                rawValues.shift();  // Remove oldest data point when exceeding window size
            }

            const smoothedValue = rawValues.reduce((acc, val) => acc + val, 0) / rawValues.length;  // Simple moving average
            smoothedValues.push(smoothedValue);

            // Update the chart data
            chart.data.labels.push(chart.data.labels.length);  // Adding sample number for X-axis
            chart.data.datasets[0].data = rawValues;  // Update raw ECG dataset
            chart.data.datasets[1].data = smoothedValues;  // Update smoothed ECG dataset

            // Keep the number of labels on the X-axis within window size
            if (chart.data.labels.length > windowSize) {
                chart.data.labels.shift();  // Remove the oldest label
            }

            chart.update();  // Redraw the chart with new data
        }

        // Add event listener to connect button
        document.getElementById('connectBtn').addEventListener('click', connectToDevice);
    </script>
</body>
</html>
